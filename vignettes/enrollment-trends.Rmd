---
title: "Maryland Enrollment Trends"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Maryland Enrollment Trends}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 10,
  fig.height = 6,
  out.width = "100%",
  message = FALSE,
  warning = FALSE
)
```

```{r load-packages}
library(mdschooldata)
library(ggplot2)
library(dplyr)
library(scales)
```

```{r theme}
theme_readme <- function() {
  theme_minimal(base_size = 14) +
    theme(
      plot.title = element_text(face = "bold", size = 16),
      plot.subtitle = element_text(color = "gray40"),
      panel.grid.minor = element_blank(),
      legend.position = "bottom"
    )
}

colors <- c("total" = "#2C3E50", "white" = "#3498DB", "black" = "#E74C3C",
            "hispanic" = "#F39C12", "asian" = "#9B59B6", "multiracial" = "#1ABC9C",
            "highlight" = "#E67E22", "secondary" = "#95A5A6")
```

```{r fetch-data, cache = TRUE}
# Get available years
years <- get_available_years()
if (is.list(years)) {
  max_year <- years$max_year
  min_year <- years$min_year
} else {
  max_year <- max(years)
  min_year <- min(years)
}

# Fetch data
enr <- fetch_enr_multi((max_year - 9):max_year, use_cache = TRUE)
enr_current <- fetch_enr(max_year, use_cache = TRUE)
```

## 1. Montgomery County is bigger than most states {#montgomery-county-is-bigger-than-most-states}

With over 160,000 students, Montgomery County Public Schools is the largest district in Maryland and among the top 20 in the nation. The district alone has more students than entire states like Wyoming or Vermont.

```{r story-01-top-districts}
top_districts <- enr_current %>%
  filter(is_district, grade_level == "TOTAL", subgroup == "total_enrollment") %>%
  arrange(desc(n_students)) %>%
  head(5) %>%
  mutate(district_label = reorder(district_name, n_students))

ggplot(top_districts, aes(x = district_label, y = n_students)) +
  geom_col(fill = colors["total"]) +
  coord_flip() +
  scale_y_continuous(labels = comma) +
  labs(title = "Maryland's Largest School Systems",
       subtitle = "Montgomery County leads with 160,000+ students",
       x = "", y = "Students") +
  theme_readme()
```

## 2. Prince George's and Montgomery: A tale of two counties {#prince-georges-and-montgomery-a-tale-of-two-counties}

Maryland's two largest systems serve similar numbers of students but have different enrollment trends. Prince George's County has seen steady enrollment while Montgomery County has experienced modest growth.

```{r story-02-pg-vs-montgomery}
pg_mont <- enr %>%
  filter(is_district, grade_level == "TOTAL",
         district_name %in% c("Montgomery", "Prince George's"),
         subgroup == "total_enrollment")

ggplot(pg_mont, aes(x = end_year, y = n_students, color = district_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  scale_color_manual(values = c("Montgomery" = "#3498DB", "Prince George's" = "#E74C3C")) +
  scale_y_continuous(labels = comma) +
  labs(title = "Montgomery vs Prince George's",
       subtitle = "Two counties, different enrollment trends",
       x = "School Year", y = "Students", color = "") +
  theme_readme()
```

## 3. Baltimore City's enrollment freefall {#baltimore-citys-enrollment-freefall}

Baltimore City has lost over 15,000 students in the past decade, a decline of nearly 20%. This reflects population loss, charter school growth, and families moving to surrounding counties.

```{r story-03-baltimore-decline}
baltimore <- enr %>%
  filter(is_district, district_name == "Baltimore City",
         subgroup == "total_enrollment", grade_level == "TOTAL")

ggplot(baltimore, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = colors["total"]) +
  geom_point(size = 3, color = colors["total"]) +
  scale_y_continuous(labels = comma, limits = c(0, NA)) +
  labs(title = "Baltimore City Enrollment Decline",
       subtitle = "Lost 15,000+ students over the past decade",
       x = "School Year", y = "Students") +
  theme_readme()
```

## 4. Maryland's enrollment is gradually declining {#marylands-enrollment-is-gradually-declining}

Statewide enrollment has declined from approximately 895,000 students in 2015 to 858,000 students in 2023, a loss of about 4%. This reflects broader demographic trends and population shifts in the region.

```{r story-04-state-total-decline}
state_total <- enr %>%
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  arrange(end_year)

ggplot(state_total, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = colors["total"]) +
  geom_point(size = 3, color = colors["total"]) +
  scale_y_continuous(labels = comma, limits = c(0, NA)) +
  labs(title = "Maryland Statewide Enrollment",
       subtitle = "Gradual decline from 895K to 858K students (2015-2023)",
       x = "School Year", y = "Students") +
  theme_readme()
```

## 5. The Eastern Shore tells a different story {#the-eastern-shore-tells-a-different-story}

Rural counties like Worcester, Somerset, and Dorchester on Maryland's Eastern Shore are losing students faster than the state average, reflecting broader rural population decline patterns.

```{r story-05-eastern-shore}
eastern_shore <- c("Worcester", "Somerset", "Dorchester", "Wicomico", "Caroline")

eastern <- enr %>%
  filter(is_district, district_name %in% eastern_shore,
         subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  group_by(end_year) %>%
  summarize(n_students = sum(n_students, na.rm = TRUE), .groups = "drop")

ggplot(eastern, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = colors["total"]) +
  geom_point(size = 3, color = colors["total"]) +
  scale_y_continuous(labels = comma) +
  labs(title = "Eastern Shore Combined Enrollment",
       subtitle = "Rural counties losing students faster than state average",
       x = "School Year", y = "Students") +
  theme_readme()
```

## 6. Kindergarten dipped during COVID {#kindergarten-dipped-during-covid}

Maryland lost 8% of kindergartners in 2021 as families delayed enrollment during the pandemic. The cohort remains smaller than pre-pandemic levels, suggesting some students never entered the system.

```{r story-06-covid-k}
k_trend <- enr %>%
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("K", "01", "06", "12")) %>%
  mutate(grade_label = case_when(
    grade_level == "K" ~ "Kindergarten",
    grade_level == "01" ~ "Grade 1",
    grade_level == "06" ~ "Grade 6",
    grade_level == "12" ~ "Grade 12"
  ))

ggplot(k_trend, aes(x = end_year, y = n_students, color = grade_label)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  geom_vline(xintercept = 2021, linetype = "dashed", color = "red", alpha = 0.5) +
  scale_y_continuous(labels = comma) +
  labs(title = "COVID Impact on Grade-Level Enrollment",
       subtitle = "Maryland lost 8% of kindergartners in 2021",
       x = "School Year", y = "Students", color = "") +
  theme_readme()
```

## 7. Howard County: A stable suburban district {#howard-county-a-stable-suburban-district}

Howard County maintains steady enrollment with over 57,000 students, making it one of Maryland's larger districts. The district serves as a key suburban area between Baltimore and Washington, D.C.

```{r story-07-howard-stable}
howard <- enr %>%
  filter(is_district, district_name == "Howard",
         subgroup == "total_enrollment", grade_level == "TOTAL")

ggplot(howard, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = colors["total"]) +
  geom_point(size = 3, color = colors["total"]) +
  scale_y_continuous(labels = comma, limits = c(0, NA)) +
  labs(title = "Howard County Enrollment",
       subtitle = "Stable suburban district with 57K+ students",
       x = "School Year", y = "Students") +
  theme_readme()
```

## 8. Allegany and Garrett: Western Maryland's struggle {#allegany-and-garrett-western-marylands-struggle}

The westernmost counties have lost over 20% of students since 2014, reflecting population decline in Appalachian Maryland. These rural mountain communities face similar challenges to rural areas nationwide.

```{r story-08-western-md}
western <- c("Allegany", "Garrett")

western_trend <- enr %>%
  filter(is_district, district_name %in% western,
         subgroup == "total_enrollment", grade_level == "TOTAL")

ggplot(western_trend, aes(x = end_year, y = n_students, color = district_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  scale_y_continuous(labels = comma) +
  labs(title = "Western Maryland Enrollment",
       subtitle = "Allegany and Garrett counties losing over 20% of students",
       x = "School Year", y = "Students", color = "") +
  theme_readme()
```

## 9. Anne Arundel holds steady {#anne-arundel-holds-steady}

Maryland's fifth-largest district has maintained enrollment stability while others fluctuate. The Annapolis-area county benefits from military families at Fort Meade and Naval Academy presence.

```{r story-09-anne-arundel}
aa <- enr %>%
  filter(is_district, district_name == "Anne Arundel",
         subgroup == "total_enrollment", grade_level == "TOTAL")

ggplot(aa, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = colors["total"]) +
  geom_point(size = 3, color = colors["total"]) +
  scale_y_continuous(labels = comma, limits = c(0, NA)) +
  labs(title = "Anne Arundel County Enrollment",
       subtitle = "Maintaining stability while others fluctuate",
       x = "School Year", y = "Students") +
  theme_readme()
```

## 10. The I-95 corridor dominates {#the-i-95-corridor-dominates}

Five counties along I-95 (Baltimore County, Montgomery, Prince George's, Howard, and Anne Arundel) enroll over 70% of all Maryland students. This concentration reflects the state's population center.

```{r story-10-i95-corridor}
i95 <- c("Baltimore County", "Montgomery", "Prince George's", "Howard", "Anne Arundel")

corridor <- enr_current %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  mutate(corridor = ifelse(district_name %in% i95, "I-95 Corridor", "Rest of Maryland")) %>%
  group_by(corridor) %>%
  summarize(n_students = sum(n_students, na.rm = TRUE), .groups = "drop")

ggplot(corridor, aes(x = corridor, y = n_students, fill = corridor)) +
  geom_col() +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("I-95 Corridor" = "#2C3E50", "Rest of Maryland" = "#95A5A6")) +
  labs(title = "The I-95 Corridor Dominates Maryland",
       subtitle = "Five counties along I-95 enroll over 70% of all students",
       x = "", y = "Students") +
  theme_readme() +
  theme(legend.position = "none")
```

## 11. Frederick County is growing fast {#frederick-county-is-growing-fast}

Frederick County, located between the DC suburbs and western Maryland, has seen steady enrollment growth as families seek more affordable housing while maintaining access to the DC job market.

```{r story-11-frederick-growth}
frederick <- enr %>%
  filter(is_district, district_name == "Frederick",
         subgroup == "total_enrollment", grade_level == "TOTAL")

ggplot(frederick, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = colors["highlight"]) +
  geom_point(size = 3, color = colors["highlight"]) +
  scale_y_continuous(labels = comma, limits = c(0, NA)) +
  labs(title = "Frederick County Enrollment Growth",
       subtitle = "DC exurbs attracting new families",
       x = "School Year", y = "Students") +
  theme_readme()
```

## 12. Total enrollment by county {#total-enrollment-by-county}

Maryland's 24 local school systems vary dramatically in size, from Montgomery County's 160,000 students to Kent County's 2,000 students. The distribution reflects the state's population centers and rural areas.

```{r story-12-county-enrollment}
county_rank <- enr_current %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  arrange(desc(n_students)) %>%
  mutate(district_label = reorder(district_name, n_students))

ggplot(county_rank, aes(x = district_label, y = n_students)) +
  geom_col(fill = colors["total"]) +
  coord_flip() +
  scale_y_continuous(labels = comma) +
  labs(title = "Maryland County Enrollment (2024)",
       subtitle = "24 Local School Systems, from 160K to 2K students",
       x = "", y = "Students") +
  theme_readme()
```

## 13. Baltimore County vs Baltimore City: Divergent paths {#baltimore-county-vs-city}

While Baltimore City enrollment plummets, Baltimore County has remained relatively stable. The county surrounds but is entirely separate from the city, and the gap continues to widen.

```{r story-13-baltimore-comparison}
baltimore_both <- enr %>%
  filter(is_district, district_name %in% c("Baltimore City", "Baltimore County"),
         subgroup == "total_enrollment", grade_level == "TOTAL")

ggplot(baltimore_both, aes(x = end_year, y = n_students, color = district_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  scale_y_continuous(labels = comma) +
  scale_color_manual(values = c("Baltimore City" = "#E74C3C", "Baltimore County" = "#3498DB")) +
  labs(title = "Baltimore City vs Baltimore County",
       subtitle = "Two systems, divergent enrollment trajectories",
       x = "School Year", y = "Students", color = "") +
  theme_readme()
```

## 14. Charles County: Southern Maryland's anchor {#charles-county-southern-maryland}

Charles County is the largest district in Southern Maryland and has maintained steady enrollment. The county serves as a bedroom community for DC-area workers seeking affordable housing.

```{r story-14-charles-county}
charles <- enr %>%
  filter(is_district, district_name == "Charles",
         subgroup == "total_enrollment", grade_level == "TOTAL")

ggplot(charles, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = colors["total"]) +
  geom_point(size = 3, color = colors["total"]) +
  scale_y_continuous(labels = comma, limits = c(0, NA)) +
  labs(title = "Charles County Enrollment",
       subtitle = "Southern Maryland's largest school system holds steady",
       x = "School Year", y = "Students") +
  theme_readme()
```

## 15. Small counties face existential challenges {#small-counties-challenges}

Kent County, Maryland's smallest district with just over 2,000 students, exemplifies the challenges facing rural Eastern Shore counties. Small enrollment makes it difficult to offer diverse programs and maintain facilities.

```{r story-15-small-counties}
small_counties <- c("Kent", "Somerset", "Garrett")

small_trend <- enr %>%
  filter(is_district, district_name %in% small_counties,
         subgroup == "total_enrollment", grade_level == "TOTAL")

ggplot(small_trend, aes(x = end_year, y = n_students, color = district_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  scale_y_continuous(labels = comma) +
  labs(title = "Maryland's Smallest School Systems",
       subtitle = "Kent, Somerset, and Garrett face enrollment pressure",
       x = "School Year", y = "Students", color = "") +
  theme_readme()
```
